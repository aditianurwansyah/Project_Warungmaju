<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üí∞ Input Penjualan ‚Äî Warung Maju</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .cart-item { padding: 12px; border-bottom: 1px solid #eee; background: #f8f9fa; }
    .cart-item:hover { background: #e9ecef; }
    .btn-pay { background: #2ecc71; color: white; font-weight: bold; }
    .btn-pay:hover { background: #27ae60; }
    .search-box { width: 100%; margin-bottom: 15px; }
    .product-suggestion { cursor: pointer; padding: 8px; border-radius: 4px; }
    .product-suggestion:hover { background: #e3f2fd; }
    .qty-input { width: 80px; text-align: center; }
    .modal-title i { margin-right: 8px; }
  </style>
</head>
<body class="bg-light">
  <header class="bg-dark text-white p-3 shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
      <h4 class="mb-0">üí∞ Input Penjualan</h4>
      <button id="btnLogout" class="btn btn-danger btn-sm">üö™ Logout</button>
    </div>
  </header>

  <div class="container mt-4">
    <!-- Keranjang Belanja -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-cart me-2" viewBox="0 0 16 16">
            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
          </svg>
          Keranjang Belanja
        </h5>
        <p id="cartStatus" class="mb-0 mt-2">üõí Keranjang kosong</p>
      </div>
      <div class="card-body">
        <div id="cartItems"></div>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <strong class="text-primary">Total:</strong>
          <span id="cartTotal" class="fs-4 fw-bold text-success">Rp 0</span>
        </div>
        <button id="btnBayar" class="btn btn-pay w-100 mt-3" disabled>
          ‚úÖ Bayar (Rp 0)
        </button>
      </div>
    </div>

    <!-- Cari & Tambah Produk -->
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search me-2" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
          Cari & Tambah Produk
        </h5>
      </div>
      <div class="card-body">
        <input type="text" id="searchProduk" class="form-control search-box" placeholder="Ketik nama produk (min. 3 karakter)...">
        <div id="produkList" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Modal Input Qty -->
  <div class="modal fade" id="qtyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box me-2" viewBox="0 0 16 16">
              <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.83l-6.5 2.6v-2.37L7.5 4.5v10.262z"/>
            </svg>
            Tambah ke Keranjang
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputQty">Jumlah</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="btnQtyMin">‚Äì</button>
              <input type="number" id="inputQty" class="form-control text-center qty-input" min="1" value="1">
              <button class="btn btn-outline-secondary" type="button" id="btnQtyPlus">+</button>
            </div>
            <div class="form-text text-muted small">
              Tersedia: <span id="stokTersedia">‚Äì</span> unit
            </div>
          </div>
          <div id="productInfo" class="alert alert-info mb-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="btnAddToCart">‚úÖ Tambah ke Keranjang</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Konfirmasi Bayar -->
  <div class="modal fade" id="bayarModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">‚úÖ Konfirmasi Pembayaran</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h5 class="mb-3">Ringkasan:</h5>
          <div id="bayarSummary"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" id="btnConfirmBayar">‚úÖ Bayar Sekarang</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ‚úÖ Global cart
    let cart = [];
    let selectedProduct = null;

    // ‚úÖ Cek session
    async function checkAuth() {
      try {
        const res = await fetch('auth/check_session.php');
        const data = await res.json();
        if (!data.logged) {
          alert('Sesi habis. Silakan login.');
          window.location.href = 'login.html';
        }
      } catch (err) {
        alert('Gagal koneksi ke server.');
        window.location.href = 'login.html';
      }
    }

    // ‚úÖ Render keranjang
    function renderCart() {
      const cartEl = document.getElementById('cartItems');
      const totalEl = document.getElementById('cartTotal');
      const statusEl = document.getElementById('cartStatus');
      const btnBayar = document.getElementById('btnBayar');

      if (cart.length === 0) {
        cartEl.innerHTML = '';
        statusEl.innerHTML = 'üõí Keranjang kosong';
        totalEl.textContent = 'Rp 0';
        btnBayar.disabled = true;
        return;
      }

      const total = cart.reduce((sum, item) => sum + (item.harga * item.qty), 0);
      statusEl.innerHTML = `üõí ${cart.length} item ‚Äî Total: Rp ${total.toLocaleString('id-ID')}`;
      totalEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
      btnBayar.disabled = false;
      btnBayar.textContent = `‚úÖ Bayar (Rp ${total.toLocaleString('id-ID')})`;

      cartEl.innerHTML = cart.map((item, i) => `
        <div class="cart-item d-flex justify-content-between align-items-center">
          <div style="flex-grow:1">
            <strong>${item.nama}</strong><br>
            <small>Harga: Rp ${item.harga.toLocaleString('id-ID')} | Stok: ${item.stok}</small>
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateQty(${i}, -1)">‚Äì</button>
            <span class="mx-2">${item.qty}</span>
            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="updateQty(${i}, 1)">+</button>
            <button class="btn btn-sm btn-danger ms-2" onclick="removeFromCart(${i})">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    // ‚úÖ Update qty
    function updateQty(index, delta) {
      cart[index].qty = Math.max(1, cart[index].qty + delta);
      if (cart[index].qty > cart[index].stok) {
        alert(`‚ùå Stok tidak mencukupi! Maksimal: ${cart[index].stok}`);
        cart[index].qty = cart[index].stok;
      }
      renderCart();
    }

    // ‚úÖ Hapus dari keranjang
    function removeFromCart(index) {
      cart.splice(index, 1);
      renderCart();
    }

    // ‚úÖ Cari produk (real-time)
    async function searchProduk() {
      const term = document.getElementById('searchProduk').value.trim().toLowerCase();
      const container = document.getElementById('produkList');

      if (term.length < 2) {
        container.innerHTML = '';
        return;
      }

      try {
        const res = await fetch('api/produk/read.php');
        const produk = await res.json();
        const matches = produk
          .filter(p => p.stok > 0 && p.nama.toLowerCase().includes(term))
          .slice(0, 5);

        if (matches.length === 0) {
          container.innerHTML = '<p class="text-muted">Tidak ada produk yang cocok</p>';
        } else {
          container.innerHTML = matches.map(p => `
            <div class="product-suggestion" 
                 onclick="showQtyModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">
              <strong>${p.nama}</strong><br>
              <small>Rp ${p.harga.toLocaleString('id-ID')} | Stok: ${p.stok}</small>
            </div>
          `).join('');
        }
      } catch (err) {
        container.innerHTML = '<p class="text-danger">Gagal memuat produk</p>';
      }
    }

    // ‚úÖ Tampilkan modal qty
    window.showQtyModal = function(produk) {
      selectedProduct = produk;
      document.getElementById('inputQty').value = 1;
      document.getElementById('stokTersedia').textContent = produk.stok;
      document.getElementById('productInfo').innerHTML = 
        `<strong>${produk.nama}</strong><br>Harga: Rp ${produk.harga.toLocaleString('id-ID')}`;
      const modal = new bootstrap.Modal(document.getElementById('qtyModal'));
      modal.show();
    };

    // ‚úÖ Tombol +/- qty
    document.getElementById('btnQtyMin').onclick = () => {
      const input = document.getElementById('inputQty');
      input.value = Math.max(1, parseInt(input.value) - 1);
    };
    document.getElementById('btnQtyPlus').onclick = () => {
      const input = document.getElementById('inputQty');
      const max = selectedProduct?.stok || 999;
      input.value = Math.min(max, parseInt(input.value) + 1);
    };

    // ‚úÖ Tambah ke keranjang
    document.getElementById('btnAddToCart').onclick = () => {
      if (!selectedProduct) return;

      const qty = parseInt(document.getElementById('inputQty').value) || 1;
      if (qty > selectedProduct.stok) {
        alert(`‚ùå Stok tidak mencukupi! Tersedia: ${selectedProduct.stok}`);
        return;
      }

      const existing = cart.find(item => item.id === selectedProduct.id);
      if (existing) {
        const newQty = existing.qty + qty;
        if (newQty > selectedProduct.stok) {
          alert(`‚ùå Total melebihi stok! Maksimal: ${selectedProduct.stok}`);
          return;
        }
        existing.qty = newQty;
      } else {
        cart.push({ ...selectedProduct, qty });
      }

      renderCart();
      selectedProduct = null;
      const modal = bootstrap.Modal.getInstance(document.getElementById('qtyModal'));
      modal.hide();
    };

    // ‚úÖ Bayar
    document.getElementById('btnBayar').onclick = () => {
      if (cart.length === 0) return;

      // Render ringkasan
      let summary = '<ul class="list-group">';
      let total = 0;
      cart.forEach(item => {
        const subtotal = item.harga * item.qty;
        total += subtotal;
        summary += `<li class="list-group-item d-flex justify-content-between">
          ${item.nama} √ó ${item.qty}
          <span>Rp ${subtotal.toLocaleString('id-ID')}</span>
        </li>`;
      });
      summary += `<li class="list-group-item bg-light d-flex justify-content-between fw-bold">
        TOTAL
        <span>Rp ${total.toLocaleString('id-ID')}</span>
      </li></ul>`;

      document.getElementById('bayarSummary').innerHTML = summary;
      const modal = new bootstrap.Modal(document.getElementById('bayarModal'));
      modal.show();
    };

    // ‚úÖ Konfirmasi bayar
    document.getElementById('btnConfirmBayar').onclick = async () => {
      if (cart.length === 0) return;

      try {
        const res = await fetch('api/transaksi/create.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cart })
        });

        const result = await res.json();

        if (result.success) {
          alert(`‚úÖ Transaksi berhasil! ID: #${result.transaksi_id}`);
          cart = [];
          renderCart();
          // Redirect ke laporan
          window.location.href = 'laporan.html';
        } else {
          alert('‚ùå Gagal: ' + (result.msg || 'Error tidak diketahui'));
        }
      } catch (err) {
        alert('‚ùå Gagal koneksi ke server');
      }
    };

    // ‚úÖ Logout
    document.getElementById('btnLogout').onclick = async () => {
      if (confirm('Yakin ingin keluar?')) {
        await fetch('auth/logout.php');
        window.location.href = 'login.html';
      }
    };

    // ‚úÖ Event listeners
    document.getElementById('searchProduk').oninput = searchProduk;

    // ‚úÖ Inisialisasi
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
<footer>
     <p class="mb-0">@Copyright by 23552011329_AditiaNurwansyah_TIFRP23CNSA_UASWEB1</p>
    &copy; 2024 Warung Maju. All rights reserved.
  </div>
</footer>
</html>
