<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“Š Laporan Penjualan â€” Warung Maju</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .stat-card { text-align: center; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .stat-value { font-size: 1.5rem; font-weight: bold; }
    .btn-report { min-width: 150px; }
    .loading { text-align: center; padding: 20px; color: #7f8c8d; }
    .error { color: #e74c3c; }
    .success { color: #2ecc71; }
  </style>
</head>
<body class="bg-light">
  <header class="bg-dark text-white p-3 shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
      <h4 class="mb-0">ğŸ“Š Laporan Penjualan</h4>
      <button id="btnLogout" class="btn btn-outline-light btn-sm">ğŸšª Logout</button>
    </div>
  </header>

  <div class="container mt-4">
    <!-- Pilih Periode -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">ğŸ“… Pilih Periode</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="start" class="form-label">Dari Tanggal</label>
            <input type="date" id="start" class="form-control" value="<?= date('Y-m-d', strtotime('-7 days')) ?>">
          </div>
          <div class="col-md-6">
            <label for="end" class="form-label">Sampai Tanggal</label>
            <input type="date" id="end" class="form-control" value="<?= date('Y-m-d') ?>">
          </div>
        </div>
        <button id="btnFilter" class="btn btn-primary mt-3 w-100">â±ï¸ Tampilkan Data</button>
      </div>
    </div>

    <!-- Ringkasan -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">ğŸ“ˆ Ringkasan</h5>
          </div>
          <div class="card-body">
            <p><strong>Transaksi:</strong> <span id="summaryTransaksi">0</span></p>
            <p><strong>Total Penjualan:</strong> <span id="summaryPenjualan">Rp 0</span></p>
            <p><strong>Produk Terlaris:</strong> <span id="produkTerlaris">â€“</span></p>
          </div>
        </div>
      </div>

      <!-- Unduh Laporan -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ“¥ Unduh Laporan</h5>
          </div>
          <div class="card-body d-flex flex-column gap-2">
            <a id="btnPdf" class="btn btn-primary btn-report" target="_blank" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-pdf me-1" viewBox="0 0 16 16">
                <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                <path d="M7.25 12h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 0 1.5zm0-2.5h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 0 1.5zm0-2.5h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 0 1.5z"/>
              </svg>
              PDF
            </a>
            <a id="btnExcel" class="btn btn-success btn-report" target="_blank" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel me-1" viewBox="0 0 16 16">
                <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4A.5.5 0 0 1 5 8zm0 2.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
              </svg>
              Excel
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Transaksi -->
    <div class="card">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">ğŸ“‹ Data Transaksi</h5>
      </div>
      <div class="card-body">
        <div id="reportStatus" class="loading">Pilih periode dan klik "Tampilkan Data"</div>
        <div id="reportData" style="display:none">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Tanggal</th>
                <th>Kasir</th>
                <th>Produk</th>
                <th>Qty</th>
                <th>Harga</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
            <tfoot>
              <tr class="table-success">
                <td colspan="5" class="text-end"><strong>TOTAL</strong></td>
                <td id="reportTotal">Rp 0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Navigasi -->
    <div class="text-center mt-4">
      <a href="dashboard.html" class="btn btn-outline-secondary">ğŸ  Kembali ke Dashboard</a>
    </div>
  </div>

  <script>
    // âœ… Utility
    function formatRupiah(angka) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(angka);
    }

    // âœ… Cek session
    async function checkAuth() {
      try {
        const res = await fetch('auth/check_session.php');
        const data = await res.json();
        if (!data.logged) {
          alert('Sesi habis. Silakan login.');
          window.location.href = 'login.html';
        }
      } catch (err) {
        alert('Gagal koneksi ke server.');
        window.location.href = 'login.html';
      }
    }

    // âœ… Update link download
    function updateDownloadLinks() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      if (start && end) {
        const baseUrl = 'laporan/generate_pdf.php';
        const params = `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
        document.getElementById('btnPdf').href = baseUrl + params;
        document.getElementById('btnExcel').href = baseUrl.replace('pdf', 'excel') + params;
        document.getElementById('btnPdf').disabled = false;
        document.getElementById('btnExcel').disabled = false;
      } else {
        document.getElementById('btnPdf').disabled = true;
        document.getElementById('btnExcel').disabled = true;
      }
    }

    // âœ… Tampilkan data
    document.getElementById('btnFilter').onclick = async () => {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      if (!start || !end) {
        alert('Pilih tanggal mulai dan akhir');
        return;
      }

      // Validasi: start <= end
      if (new Date(start) > new Date(end)) {
        alert('Tanggal mulai tidak boleh lebih besar dari tanggal akhir');
        return;
      }

      const statusEl = document.getElementById('reportStatus');
      const dataEl = document.getElementById('reportData');
      const tableBody = document.getElementById('reportTableBody');
      const totalEl = document.getElementById('reportTotal');

      statusEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Memuat data...';
      statusEl.className = 'loading';
      dataEl.style.display = 'none';

      try {
        const url = `api/transaksi/read.php?start=${start}&end=${end}`;
        const res = await fetch(url);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          statusEl.innerHTML = '<span class="error">Tidak ada transaksi di periode ini</span>';
          return;
        }

        // Render tabel
        let html = '';
        let grandTotal = 0;
        const produkCount = {};

        data.forEach(r => {
          const subtotal = r.qty * r.harga_satuan;
          grandTotal += subtotal;
          produkCount[r.produk] = (produkCount[r.produk] || 0) + r.qty;

          html += `
            <tr>
              <td>${new Date(r.tanggal).toLocaleString('id-ID')}</td>
              <td>${r.kasir}</td>
              <td>${r.produk}</td>
              <td class="text-center">${r.qty}</td>
              <td class="text-end">${formatRupiah(r.harga_satuan)}</td>
              <td class="text-end">${formatRupiah(subtotal)}</td>
            </tr>`;
        });

        tableBody.innerHTML = html;
        totalEl.textContent = formatRupiah(grandTotal);
        document.getElementById('summaryTransaksi').textContent = data.length;
        document.getElementById('summaryPenjualan').textContent = formatRupiah(grandTotal);

        // Produk terlaris
        const terlaris = Object.entries(produkCount)
          .sort((a, b) => b[1] - a[1])[0];
        document.getElementById('produkTerlaris').textContent = 
          terlaris ? `${terlaris[0]} (${terlaris[1]} unit)` : 'â€“';

        // Tampilkan data
        statusEl.style.display = 'none';
        dataEl.style.display = 'block';

        // Update link download
        updateDownloadLinks();

      } catch (err) {
        statusEl.innerHTML = `<span class="error">âŒ Gagal memuat: ${err.message}</span>`;
        console.error('Fetch error:', err);
      }
    };

    // âœ… Logout
    document.getElementById('btnLogout').onclick = async () => {
      if (confirm('Yakin ingin keluar?')) {
        try {
          await fetch('auth/logout.php');
          window.location.href = 'login.html';
        } catch (err) {
          window.location.href = 'login.html';
        }
      }
    };

    // âœ… Event listeners
    document.getElementById('start').onchange = updateDownloadLinks;
    document.getElementById('end').onchange = updateDownloadLinks;

    // âœ… Inisialisasi
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      updateDownloadLinks(); // Set link default
    });
  </script>
</body>
</html>